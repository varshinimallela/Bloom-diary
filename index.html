<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bloom Diary — All-in-One</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
        --soft-pink: #FF8FAB;
        --lavender: #E5CFF7;
        --baby-blue: #AEE1F9;
        --cream: #FFF1F5;
        --mint-green: #A8D8B9;
        --deep-plum: #2D1E2F;
        --light-plum: #5D4E5F;
    }
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: var(--cream);
      transition: background-color 0.5s ease;
      overflow-x: hidden;
    }
    body.dark-mode {
      background-color: var(--deep-plum);
      color: var(--cream);
    }
    .app-title {
      font-family: 'Dancing Script', cursive;
    }
    .diary-entry {
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    body.dark-mode .diary-entry {
      background-color: var(--light-plum);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .date-circle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .date-circle::before {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FF8FAB' d='M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm0 80c-16.6 0-30-13.4-30-30s13.4-30 30-30 30 13.4 30 30-13.4 30-30 30z'/%3E%3C/svg%3E");
      background-size: contain;
      opacity: 0.2;
      z-index: -1;
    }
    .date-circle:hover {
      transform: scale(1.1);
    }
    .date-circle.selected {
      background-color: var(--soft-pink);
      color: white;
      transform: scale(1.1);
    }
    .date-circle.selected::before {
      opacity: 0.5;
    }
    .mood-emoji {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .mood-emoji:hover {
      transform: scale(1.2);
    }
    .mood-emoji.selected {
      transform: scale(1.2);
      filter: drop-shadow(0 0 5px rgba(255, 143, 171, 0.8));
    }
    .save-btn {
      background-color: var(--soft-pink);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .save-btn:hover {
      transform: scale(1.05);
      background-color: #ff7a9a;
    }
    .save-btn:active {
      transform: scale(0.95);
    }
    .save-btn::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      transition: transform 0.5s, opacity 0.5s;
    }
    .save-btn:active::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      transition: 0s;
    }
    .theme-toggle {
      width: 60px;
      height: 30px;
      background-color: var(--lavender);
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    body.dark-mode .theme-toggle {
      background-color: var(--light-plum);
    }
    .toggle-circle {
      width: 26px;
      height: 26px;
      background-color: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    body.dark-mode .toggle-circle {
      left: 32px;
      background-color: var(--deep-plum);
    }
    .floating-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--soft-pink);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      bottom: 20px;
      right: 20px;
      transition: all 0.3s ease;
      z-index: 100;
    }
    .floating-btn:hover {
      transform: scale(1.1) rotate(10deg);
    }
    .floating-btn:active {
      transform: scale(0.9);
    }
    .petals-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    .petal {
      position: absolute;
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.6;
      animation: falling linear infinite;
    }
    @keyframes falling {
      0% { transform: translateY(-5%) rotate(0deg);}
      100% { transform: translateY(105%) rotate(360deg);}
    }
    .floral-border {
      position: relative;
    }
    .floral-border::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='20' viewBox='0 0 100 20'%3E%3Cpath fill='%23FF8FAB' d='M0,10 C30,20 70,0 100,10 L100,0 L0,0 Z'/%3E%3C/svg%3E");
      background-size: 100px 20px;
      background-repeat: repeat-x;
    }
    .floral-border::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='20' viewBox='0 0 100 20'%3E%3Cpath fill='%23FF8FAB' d='M0,10 C30,0 70,20 100,10 L100,20 L0,20 Z'/%3E%3C/svg%3E");
      background-size: 100px 20px;
      background-repeat: repeat-x;
    }
    body.dark-mode .floral-border::before,
    body.dark-mode .floral-border::after {
      filter: hue-rotate(180deg) brightness(0.7);
    }
    .page-container {
      transition: transform 0.5s ease;
    }
    .page-container.slide-left {
      transform: translateX(-100%);
    }
    .page-container.slide-right {
      transform: translateX(100%);
    }
    .notebook-lines {
      background-image: linear-gradient(transparent 29px, #E5CFF7 30px);
      background-size: 100% 30px;
      line-height: 30px;
      padding-top: 0;
      font-size: 16px;
    }
    body.dark-mode .notebook-lines {
      background-image: linear-gradient(transparent 29px, #5D4E5F 30px);
    }
    .calendar-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .bloom-year {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .bloom-month {
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }
    body.dark-mode .bloom-month {
      background-color: rgba(93, 78, 95, 0.7);
    }
    .bloom-month:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .photo-upload {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--lavender);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .photo-upload:hover {
      transform: scale(1.1);
      background-color: var(--soft-pink);
    }
    body.dark-mode .photo-upload {
      background-color: var(--light-plum);
    }
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-track { background: rgba(229, 207, 247, 0.3); border-radius: 10px;}
    ::-webkit-scrollbar-thumb { background: var(--soft-pink); border-radius: 10px;}
    ::-webkit-scrollbar-thumb:hover { background: #ff7a9a;}
    body.dark-mode ::-webkit-scrollbar-track { background: rgba(93, 78, 95, 0.3);}
    body.dark-mode ::-webkit-scrollbar-thumb { background: var(--light-plum);}
    /* Auth panel styles */
    .cute-btn {
      background: #FF8FAB;
      color: #fff;
      border-radius: 9999px;
      padding: 0.35rem 1.1rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 8px #ffe2ee79;
      transition: background 0.15s, transform 0.1s;
    }
    .cute-btn:hover { background: #ff7a9a; transform: scale(1.05);}
    .icon-btn {
      background: #e5cff7;
      color: #5d4e5f;
      border-radius: 9999px;
      padding: 0.23rem 0.7rem;
      margin-left: 4px;
      margin-right: 2px;
      font-size: 1.1rem;
      transition: background 0.1s, color 0.1s;
      box-shadow: 0 1px 4px #e5cff7a2;
    }
    .icon-btn:hover { background: #ff8fab; color: #fff;}
    .logout-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 8px;
      font-size: 1.2rem;
      color: #ff8fab;
    }
    .logout-btn:hover { color: #e5739a; }
    .modal-bg {
      background: rgba(255, 143, 171, 0.13);
      backdrop-filter: blur(2px);
      position: fixed; top:0; left:0; width:100vw;height:100vh;z-index:50;
      display: flex;align-items:center;justify-content:center;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 28px #e5cff7;
      padding: 2em 2.5em;
      min-width: 240px;
      text-align: center;
    }
    .modal button { margin: 0.6em 0.6em 0 0; }
    .entry-card {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(229,207,247,0.15);
      transition: transform 0.15s;
    }
    .entry-card:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 4px 15px #e5cff7;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Petals -->
  <div class="petals-container" id="petalsContainer"></div>
  <!-- Top Bar -->
  <nav class="flex items-center justify-between px-4 py-3 md:px-10">
    <span class="app-title text-3xl text-pink-500 flex items-center gap-2">
      <span>Bloom Diary</span>
      <span aria-label="flower" class="text-2xl">🌸</span>
    </span>
    <div id="userStatus" class="flex items-center gap-2"></div>
  </nav>
  <!-- Auth Panel -->
  <section id="authPanel" class="w-full max-w-xs mx-auto mt-8 mb-2 bg-white/90 rounded-xl shadow-lg p-6 flex flex-col gap-4 border border-pink-100">
    <h2 class="text-xl font-semibold text-pink-500 text-center">Welcome!</h2>
    <input id="username" type="text" placeholder="Username"
      class="rounded-lg px-3 py-2 border border-pink-100 focus:ring-2 focus:ring-pink-200 font-medium bg-pink-50/60"/>
    <input id="password" type="password" placeholder="Password"
      class="rounded-lg px-3 py-2 border border-pink-100 focus:ring-2 focus:ring-pink-200 font-medium bg-pink-50/60"/>
    <div class="flex gap-4 justify-center mt-2">
      <button class="cute-btn" id="registerBtn">Register</button>
      <button class="cute-btn" id="loginBtn">Login</button>
    </div>
    <div id="authMsg" class="text-center mt-2 text-sm text-pink-600"></div>
  </section>
  <!-- Main App Pages (hidden until logged in) -->
  <div class="page-container hidden" id="pageContainer">
    <!-- Home/Dashboard Screen -->
    <div class="px-4 py-6 min-h-screen flex flex-col" id="homePage">
      <header class="flex justify-between items-center mb-6">
        <div class="flex gap-2">
          <h1 class="app-title text-4xl font-bold text-pink-500 dark:text-pink-300">Bloom Diary</h1>
        </div>
        <div class="theme-toggle" id="themeToggle">
          <div class="toggle-circle" id="toggleCircle">🌞</div>
        </div>
      </header>
      <div class="text-center mb-8">
        <p class="italic text-lg text-gray-600 dark:text-gray-300">"Let your thoughts bloom 🌸"</p>
      </div>
      <!-- Year view with all months -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-purple-600 dark:text-purple-300 mb-4">My Garden of Memories</h2>
        <div class="grid grid-cols-3 gap-4">
          <!-- Month cards (JS will update progress bars) -->
          <template id="monthCardTemplate">
            <div class="month-card">
              <div class="diary-entry p-4 text-center transform transition-all hover:scale-105 hover:shadow-lg">
                <h3 class="font-medium mb-2"></h3>
                <div class="flex justify-center"><span class="text-3xl"></span></div>
                <div class="flower-progress mt-2">
                  <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-pink-400 rounded-full" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
      <!-- Recent entries preview -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold text-purple-600 dark:text-purple-300 mb-4">Recent Blooms</h2>
        <div class="space-y-4" id="recentEntries">
          <p class="text-center text-gray-500 italic py-4" id="noEntriesMessage">No entries yet. Start your journey by adding your first bloom!</p>
        </div>
      </div>
      <button class="floating-btn" id="newEntryBtn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
    </div>
    <!-- Diary Entry Page -->
    <div class="px-4 py-6 min-h-screen flex flex-col hidden" id="entryPage">
      <header class="flex justify-between items-center mb-6">
        <button class="w-10 h-10 rounded-full bg-lavender flex items-center justify-center" id="backToHomeBtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <h2 class="text-xl font-semibold" id="entryDate"></h2>
        <div class="w-10 h-10"></div>
      </header>
      <!-- Mood tracker -->
      <div class="mb-6">
        <h3 class="text-lg font-medium text-purple-600 dark:text-purple-300 mb-3">How are you blooming today?</h3>
        <div class="grid grid-cols-5 gap-2" id="moodGrid">
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="radiant">
            <span class="text-3xl mb-1">🌸</span><span class="text-xs text-center text-gray-800">Radiant</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="peaceful">
            <span class="text-3xl mb-1">🦋</span><span class="text-xs text-center text-gray-800">Peaceful</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="inspired">
            <span class="text-3xl mb-1">✨</span><span class="text-xs text-center text-gray-800">Inspired</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="loved">
            <span class="text-3xl mb-1">💕</span><span class="text-xs text-center text-gray-800">Loved</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="grateful">
            <span class="text-3xl mb-1">🙏</span><span class="text-xs text-center text-gray-800">Grateful</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="dreamy">
            <span class="text-3xl mb-1">🌙</span><span class="text-xs text-center text-gray-800">Dreamy</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="cozy">
            <span class="text-3xl mb-1">☕</span><span class="text-xs text-center text-gray-800">Cozy</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="reflective">
            <span class="text-3xl mb-1">🌊</span><span class="text-xs text-center text-gray-800">Reflective</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="melancholy">
            <span class="text-3xl mb-1">🌧️</span><span class="text-xs text-center text-gray-800">Wistful</span>
          </div>
          <div class="mood-emoji p-3 rounded-lg bg-white border border-pink-200 flex flex-col items-center transform transition-all hover:scale-105" data-mood="growing">
            <span class="text-3xl mb-1">🌱</span><span class="text-xs text-center text-gray-800">Growing</span>
          </div>
        </div>
      </div>
      <div class="floral-border flex-grow mb-6 pt-6 pb-6">
        <textarea 
          id="diaryText" 
          class="w-full h-64 md:h-80 p-4 rounded-lg notebook-lines resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 dark:focus:ring-pink-500 dark:bg-gray-800 dark:text-white bg-white text-gray-800"
          placeholder="Write your thoughts, dreams, and reflections here... Let your words bloom across these pages like wildflowers in a secret garden. What made you smile today? What stirred your soul? What gentle whispers did the universe share with you? This is your sacred space to capture the poetry of your everyday moments..."
        ></textarea>
      </div>
      <div class="flex justify-between items-center">
        <div class="photo-upload">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </div>
        <button class="save-btn px-8 py-3 rounded-full text-white font-medium flex items-center space-x-2" id="saveEntryBtn">
          <span>Save</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </div>
    </div>
    <!-- Month View -->
    <div class="px-4 py-6 min-h-screen flex flex-col hidden" id="monthView">
      <header class="flex justify-between items-center mb-6">
        <button class="w-10 h-10 rounded-full bg-lavender flex items-center justify-center" id="backFromMonthBtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <h2 class="text-xl font-semibold" id="monthViewTitle"></h2>
        <div class="w-10 h-10"></div>
      </header>
      <div class="mb-6">
        <div class="calendar-container mb-2">
          <div class="text-center text-sm font-medium text-gray-500">Sun</div>
          <div class="text-center text-sm font-medium text-gray-500">Mon</div>
          <div class="text-center text-sm font-medium text-gray-500">Tue</div>
          <div class="text-center text-sm font-medium text-gray-500">Wed</div>
          <div class="text-center text-sm font-medium text-gray-500">Thu</div>
          <div class="text-center text-sm font-medium text-gray-500">Fri</div>
          <div class="text-center text-sm font-medium text-gray-500">Sat</div>
        </div>
        <div class="calendar-container" id="monthCalendar"></div>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-purple-600 dark:text-purple-300 mb-4">This Month's Blooms</h3>
        <div class="space-y-4" id="monthEntries"></div>
      </div>
    </div>
    <!-- Year in Bloom View (static sample, for extension) -->
    <div class="px-4 py-6 min-h-screen flex flex-col hidden" id="yearView">
      <header class="flex justify-between items-center mb-6">
        <button class="w-10 h-10 rounded-full bg-lavender flex items-center justify-center" id="backFromYearBtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <h2 class="text-xl font-semibold">Year in Bloom - <span id="bloomYear"></span></h2>
        <div class="w-10 h-10"></div>
      </header>
      <div class="bloom-year grid-cols-3 gap-4" id="yearGrid"></div>
    </div>
  </div>
  <!-- Delete Confirmation Modal -->
  <div id="modalBg" class="modal-bg hidden">
    <div class="modal">
      <div class="mb-2">Are you sure you want to delete this entry?</div>
      <button class="cute-btn" id="confirmDeleteBtn">Yes, Delete</button>
      <button class="icon-btn" id="cancelDeleteBtn">Cancel</button>
    </div>
  </div>
  <script>
    //---------- Auth and User State -------------
    function getUsers() { return JSON.parse(localStorage.getItem('bloom_users')||'{}'); }
    function setUsers(users) { localStorage.setItem('bloom_users', JSON.stringify(users)); }
    function getLoggedInUser() { return localStorage.getItem('bloom_loggedin'); }
    function setLoggedInUser(username) { localStorage.setItem('bloom_loggedin', username); }
    function clearLoggedInUser() { localStorage.removeItem('bloom_loggedin'); }
    // Per-user diary key
    function getDiaryKey(username) { return 'bloomDiaryEntries_' + username; }
    function getAllEntries(username) {
      return JSON.parse(localStorage.getItem(getDiaryKey(username)) || '{}');
    }
    function setAllEntries(username, entries) {
      localStorage.setItem(getDiaryKey(username), JSON.stringify(entries));
    }
    //---------- DOM refs -------------
    const authPanel = document.getElementById('authPanel');
    const userStatus = document.getElementById('userStatus');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const authMsg = document.getElementById('authMsg');
    const pageContainer = document.getElementById('pageContainer');
    const homePage = document.getElementById('homePage');
    const entryPage = document.getElementById('entryPage');
    const monthView = document.getElementById('monthView');
    const yearView = document.getElementById('yearView');
    const newEntryBtn = document.getElementById('newEntryBtn');
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const backFromMonthBtn = document.getElementById('backFromMonthBtn');
    const backFromYearBtn = document.getElementById('backFromYearBtn');
    const entryDate = document.getElementById('entryDate');
    const monthViewTitle = document.getElementById('monthViewTitle');
    const monthCalendar = document.getElementById('monthCalendar');
    const monthEntries = document.getElementById('monthEntries');
    const petalsContainer = document.getElementById('petalsContainer');
    const saveEntryBtn = document.getElementById('saveEntryBtn');
    const diaryText = document.getElementById('diaryText');
    const moodGrid = document.getElementById('moodGrid');
    const recentEntries = document.getElementById('recentEntries');
    const noEntriesMessage = document.getElementById('noEntriesMessage');
    const modalBg = document.getElementById('modalBg');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    // Month/Year UI
    const bloomYear = document.getElementById('bloomYear');
    const yearGrid = document.getElementById('yearGrid');
    // Theme UI
    const themeToggle = document.getElementById('themeToggle');
    const toggleCircle = document.getElementById('toggleCircle');
    //---------- Month/emoji refs -------------
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const monthEmojis = ["❄️", "💕", "🌱", "🌷", "🌸", "🌻", "🦋", "🌿", "🍃", "🍁", "🍂", "✨"];
    // For month cards
    function makeMonthCards() {
      const grid = homePage.querySelector('.grid.grid-cols-3');
      grid.innerHTML = '';
      for (let i = 0; i < 12; i++) {
        const card = document.createElement('div');
        card.className = 'month-card';
        card.onclick = () => showMonthView(i);
        card.innerHTML = `
          <div class="diary-entry p-4 text-center transform transition-all hover:scale-105 hover:shadow-lg">
            <h3 class="font-medium mb-2">${monthNames[i]}</h3>
            <div class="flex justify-center"><span class="text-3xl">${monthEmojis[i]}</span></div>
            <div class="flower-progress mt-2">
              <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-pink-400 rounded-full" style="width: 0%"></div>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);
      }
    }
    //---------- Auth logic -------------
    registerBtn.onclick = function() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      if (!username || !password) return showAuthMsg('Username & password required');
      let users = getUsers();
      if (users[username]) return showAuthMsg('Username taken. Try login.');
      users[username] = { password };
      setUsers(users);
      showAuthMsg('Registered! You can now login.', true);
    };
    loginBtn.onclick = function() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      let users = getUsers();
      if (!users[username]) return showAuthMsg('User not found.');
      if (users[username].password !== password) return showAuthMsg('Wrong password!');
      setLoggedInUser(username);
      loadApp();
    };
    function showAuthMsg(msg, success=false) {
      authMsg.innerText = msg;
      authMsg.style.color = success ? '#41b983' : '#ff8fab';
    }
    function logout() {
      clearLoggedInUser();
      authPanel.classList.remove('hidden');
      pageContainer.classList.add('hidden');
      userStatus.innerHTML = '';
      diaryText.value = '';
    }
    //---------- App Navigation -------------
    function loadApp() {
      const username = getLoggedInUser();
      if (!username) return;
      authPanel.classList.add('hidden');
      pageContainer.classList.remove('hidden');
      userStatus.innerHTML = `
        <span class="rounded-xl px-3 py-1 bg-pink-50 text-pink-500 font-semibold shadow flex items-center gap-1" style="font-family:'Dancing Script',cursive;">
          <span aria-label="flower" class="text-lg">🌷</span>
          Logged in as: <span class="ml-1">${username}</span>
          <button class="logout-btn" title="Logout" onclick="logout()" aria-label="Logout">
            <span>🚪</span>
          </button>
        </span>`;
      showPage(homePage);
      makeMonthCards();
      updateEntryCounters();
      loadRecentEntries();
      diaryText.value = '';
      entryEditingDateKey = null;
      selectedMood = null;
    }
    function showPage(page) {
      [homePage, entryPage, monthView, yearView].forEach(p => p.classList.add('hidden'));
      page.classList.remove('hidden');
    }
    // Navigation
    newEntryBtn.onclick = () => {
      const today = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      entryDate.textContent = today.toLocaleDateString('en-US', options);
      entryEditingDateKey = dateKeyFromDate(today);
      loadEntryToForm(entryEditingDateKey);
      showPage(entryPage);
    };
    backToHomeBtn.onclick = () => showPage(homePage);
    backFromMonthBtn.onclick = () => showPage(homePage);
    backFromYearBtn && (backFromYearBtn.onclick = () => showPage(homePage));
    //---------- Theme toggle -------------
    themeToggle.onclick = () => {
      document.body.classList.toggle('dark-mode');
      toggleCircle.textContent = document.body.classList.contains('dark-mode') ? '🌙' : '🌞';
    };
    //---------- Petals animation -------------
    function createPetals() {
      const petalCount = 15;
      const petalTypes = [
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FF8FAB' d='M12,1C8.1,1,5,4.1,5,8c0,4,7,15,7,15s7-11,7-15C19,4.1,15.9,1,12,1z'/%3E%3C/svg%3E",
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23E5CFF7' d='M12,1C8.1,1,5,4.1,5,8c0,4,7,15,7,15s7-11,7-15C19,4.1,15.9,1,12,1z'/%3E%3C/svg%3E",
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23A8D8B9' d='M12,1C8.1,1,5,4.1,5,8c0,4,7,15,7,15s7-11,7-15C19,4.1,15.9,1,12,1z'/%3E%3C/svg%3E"
      ];
      for (let i = 0; i < petalCount; i++) {
        const petal = document.createElement('div');
        petal.className = 'petal';
        const size = Math.random() * 20 + 10; // 10-30px
        const posX = Math.random() * 100; // 0-100%
        const delay = Math.random() * 20; // 0-20s
        const duration = Math.random() * 10 + 10; // 10-20s
        const petalType = petalTypes[Math.floor(Math.random() * petalTypes.length)];
        petal.style.width = `${size}px`;
        petal.style.height = `${size}px`;
        petal.style.left = `${posX}%`;
        petal.style.backgroundImage = `url("${petalType}")`;
        petal.style.animationDuration = `${duration}s`;
        petal.style.animationDelay = `${delay}s`;
        petalsContainer.appendChild(petal);
      }
    }
    //---------- Diary logic -------------
    let entryEditingDateKey = null, selectedMood = null, deletingDateKey = null;
    function dateKeyFromDate(date) {
      if (typeof date === "string") date = new Date(date);
      return `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
    }
    function dateObjFromKey(dateKey) {
      const [y,m,d] = dateKey.split('-').map(Number);
      return new Date(y, m-1, d);
    }
    function saveEntry(dateKey, entry) {
      const username = getLoggedInUser();
      let entries = getAllEntries(username);
      entries[dateKey] = entry;
      setAllEntries(username, entries);
      updateEntryCounters();
    }
    function loadEntry(dateKey) {
      const username = getLoggedInUser();
      const entries = getAllEntries(username);
      return entries[dateKey] || null;
    }
    // Save entry from form
    saveEntryBtn.onclick = () => {
      const username = getLoggedInUser();
      if (!username) return;
      let dateKey = entryEditingDateKey;
      let text = diaryText.value.trim();
      if (!text) return;
      // Find selected mood
      let moodObj = null;
      moodGrid.querySelectorAll('.mood-emoji').forEach(emoji => {
        if (emoji.classList.contains('selected')) {
          moodObj = {
            emoji: emoji.querySelector('span').textContent,
            name: emoji.dataset.mood
          };
        }
      });
      const entry = {
        date: dateKey,
        text,
        mood: moodObj,
        timestamp: Date.now()
      };
      saveEntry(dateKey, entry);
      loadRecentEntries();
      updateEntryCounters();
      // Show saved message
      const savedMsg = document.createElement('div');
      savedMsg.textContent = 'Entry saved! ✨';
      savedMsg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 text-green-800 px-4 py-2 rounded-full shadow-lg z-50';
      document.body.appendChild(savedMsg);
      setTimeout(() => {
        savedMsg.style.opacity = '0';
        savedMsg.style.transition = 'opacity 0.5s ease';
        setTimeout(() => { document.body.removeChild(savedMsg); }, 500);
      }, 1200);
      showPage(homePage);
      loadRecentEntries();
    };
    // Mood emoji selection
    moodGrid.querySelectorAll('.mood-emoji').forEach(emoji => {
      emoji.onclick = () => {
        moodGrid.querySelectorAll('.mood-emoji').forEach(e => e.classList.remove('selected'));
        emoji.classList.add('selected');
        emoji.style.transform = 'scale(1.1)';
        setTimeout(() => emoji.style.transform = '', 200);
      };
    });
    function loadEntryToForm(dateKey) {
      const entry = loadEntry(dateKey);
      diaryText.value = entry ? entry.text : '';
      moodGrid.querySelectorAll('.mood-emoji').forEach(e => e.classList.remove('selected'));
      if (entry && entry.mood) {
        moodGrid.querySelectorAll('.mood-emoji').forEach(emoji => {
          if (emoji.dataset.mood === entry.mood.name) emoji.classList.add('selected');
        });
      }
    }
    // Show an entry for editing
    function showDiaryEntry(dateKey) {
      const dateObj = dateObjFromKey(dateKey);
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      entryDate.textContent = dateObj.toLocaleDateString('en-US', options);
      entryEditingDateKey = dateKey;
      loadEntryToForm(dateKey);
      showPage(entryPage);
    }
    //---------- Month Calendar + Entries -------------
    function showMonthView(monthIndex) {
      const currentYear = new Date().getFullYear();
      monthViewTitle.textContent = `${monthNames[monthIndex]} ${currentYear}`;
      generateMonthCalendar(monthIndex);
      generateMonthEntries(monthIndex);
      showPage(monthView);
    }
    function generateMonthCalendar(monthIndex) {
      monthCalendar.innerHTML = '';
      const currentYear = new Date().getFullYear();
      const firstDay = new Date(currentYear, monthIndex, 1);
      const lastDay = new Date(currentYear, monthIndex + 1, 0);
      for (let i = 0; i < firstDay.getDay(); i++) monthCalendar.appendChild(document.createElement('div'));
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateCell = document.createElement('div');
        dateCell.className = 'date-circle mx-auto';
        const dateKey = `${currentYear}-${monthIndex+1}-${day}`;
        if (loadEntry(dateKey)) {
          dateCell.style.backgroundColor = 'rgba(255, 143, 171, 0.2)';
          dateCell.style.border = '1px solid rgba(255, 143, 171, 0.5)';
        }
        dateCell.textContent = day;
        dateCell.onclick = () => showDiaryEntry(dateKey);
        monthCalendar.appendChild(dateCell);
      }
    }
    function generateMonthEntries(monthIndex) {
      monthEntries.innerHTML = '';
      const currentYear = new Date().getFullYear();
      const username = getLoggedInUser();
      const allEntries = getAllEntries(username);
      const monthEntryList = [];
      for (const dateKey in allEntries) {
        const [year, month] = dateKey.split('-').map(Number);
        if (year === currentYear && month === monthIndex+1) {
          monthEntryList.push({ dateKey, entry: allEntries[dateKey] });
        }
      }
      monthEntryList.sort((a, b) => b.entry.timestamp - a.entry.timestamp);
      if (monthEntryList.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'text-center text-gray-500 italic py-4';
        emptyMessage.textContent = 'No entries yet for this month. Your future blooms await!';
        monthEntries.appendChild(emptyMessage);
        return;
      }
      monthEntryList.forEach(item => {
        const entry = item.entry;
        const dateObj = dateObjFromKey(item.dateKey);
        const day = dateObj.getDate();
        const entryDiv = document.createElement('div');
        entryDiv.className = 'diary-entry p-4 flex justify-between items-center';
        const moodEmoji = entry.mood ? entry.mood.emoji : '📝';
        entryDiv.innerHTML = `
          <div>
            <span class="font-medium">${monthNames[monthIndex]} ${day}, ${currentYear}</span>
            <span class="text-xl">${moodEmoji}</span>
            <div class="text-gray-600 dark:text-gray-300 line-clamp-2">${entry.text}</div>
          </div>
          <div class="flex gap-1">
            <button class="icon-btn" title="Edit" aria-label="Edit"><span>✏️</span></button>
            <button class="icon-btn" title="Delete" aria-label="Delete"><span>🗑️</span></button>
          </div>
        `;
        entryDiv.querySelector('button[title="Edit"]').onclick = (e) => {
          e.stopPropagation();
          showDiaryEntry(item.dateKey);
        };
        entryDiv.querySelector('button[title="Delete"]').onclick = (e) => {
          e.stopPropagation();
          deletingDateKey = item.dateKey;
          modalBg.classList.remove('hidden');
        };
        entryDiv.onclick = () => showDiaryEntry(item.dateKey);
        monthEntries.appendChild(entryDiv);
      });
    }
    //---------- Recent entries -------------
    function loadRecentEntries() {
      const username = getLoggedInUser();
      const allEntries = getAllEntries(username);
      const entriesArray = Object.values(allEntries);
      entriesArray.sort((a, b) => b.timestamp - a.timestamp);
      const recentEntriesArray = entriesArray.slice(0, 3);
      Array.from(recentEntries.children).forEach(child => {
        if (child.id !== 'noEntriesMessage') recentEntries.removeChild(child);
      });
      if (recentEntriesArray.length === 0) {
        noEntriesMessage.style.display = 'block';
        return;
      } else {
        noEntriesMessage.style.display = 'none';
      }
      recentEntriesArray.forEach(entry => {
        const dateObj = dateObjFromKey(entry.date);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = dateObj.toLocaleDateString('en-US', options);
        const entryDiv = document.createElement('div');
        entryDiv.className = 'diary-entry p-4 flex justify-between items-center';
        const moodEmoji = entry.mood ? entry.mood.emoji : '📝';
        entryDiv.innerHTML = `
          <div>
            <span class="font-medium">${formattedDate}</span>
            <span class="text-xl">${moodEmoji}</span>
            <div class="text-gray-600 dark:text-gray-300 line-clamp-2">${entry.text}</div>
          </div>
          <div class="flex gap-1">
            <button class="icon-btn" title="Edit" aria-label="Edit"><span>✏️</span></button>
            <button class="icon-btn" title="Delete" aria-label="Delete"><span>🗑️</span></button>
          </div>
        `;
        entryDiv.querySelector('button[title="Edit"]').onclick = (e) => {
          e.stopPropagation();
          showDiaryEntry(entry.date);
        };
        entryDiv.querySelector('button[title="Delete"]').onclick = (e) => {
          e.stopPropagation();
          deletingDateKey = entry.date;
          modalBg.classList.remove('hidden');
        };
        entryDiv.onclick = () => showDiaryEntry(entry.date);
        recentEntries.appendChild(entryDiv);
      });
    }
    //---------- Entry counters for months -------------
    function updateEntryCounters() {
      const username = getLoggedInUser();
      const allEntries = getAllEntries(username);
      const entriesByMonth = {};
      for (const dateKey in allEntries) {
        const dateParts = dateKey.split('-');
        const year = dateParts[0];
        const month = parseInt(dateParts[1]) - 1;
        if (year == new Date().getFullYear()) {
          entriesByMonth[month] = (entriesByMonth[month] || 0) + 1;
        }
      }
      const progressBars = homePage.querySelectorAll('.flower-progress .bg-pink-400');
      for (let i = 0; i < 12; i++) {
        const count = entriesByMonth[i] || 0;
        const percentage = Math.min(count * 3, 100); // 3% per entry, max 100%
        if (progressBars[i]) progressBars[i].style.width = `${percentage}%`;
      }
    }
    //---------- Delete Confirmation Modal -------------
    confirmDeleteBtn.onclick = function() {
      const username = getLoggedInUser();
      let entries = getAllEntries(username);
      if (deletingDateKey && entries[deletingDateKey]) {
        delete entries[deletingDateKey];
        setAllEntries(username, entries);
        updateEntryCounters();
        loadRecentEntries();
        generateMonthEntries(new Date().getMonth());
      }
      deletingDateKey = null;
      modalBg.classList.add('hidden');
    };
    cancelDeleteBtn.onclick = function() {
      deletingDateKey = null;
      modalBg.classList.add('hidden');
    };
    //---------- App Init, Touch swipes, Petals -------------
    document.addEventListener('DOMContentLoaded', () => {
      createPetals();
      if (getLoggedInUser()) loadApp();
      // Touch swipe navigation for mobile
      let touchStartX = 0, touchEndX = 0;
      document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
      document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        const swipeThreshold = 50;
        if (touchEndX - touchStartX > swipeThreshold) {
          if (!homePage.classList.contains('hidden')){} 
          else if (!entryPage.classList.contains('hidden')) backToHomeBtn.click();
          else if (!monthView.classList.contains('hidden')) backFromMonthBtn.click();
          else if (!yearView.classList.contains('hidden')) backFromYearBtn && backFromYearBtn.click();
        }
        if (touchStartX - touchEndX > swipeThreshold) {
          if (!homePage.classList.contains('hidden')) newEntryBtn.click();
        }
      });
    });
    window.logout = logout;
  </script>
</body>
</html>